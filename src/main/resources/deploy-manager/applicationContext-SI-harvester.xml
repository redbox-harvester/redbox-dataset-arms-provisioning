<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:jdbc="http://www.springframework.org/schema/jdbc"
  xmlns="http://www.springframework.org/schema/beans" xmlns:int="http://www.springframework.org/schema/integration"
  xmlns:int-jms="http://www.springframework.org/schema/integration/jms" xmlns:int-file="http://www.springframework.org/schema/integration/file"
  xmlns:int-jdbc="http://www.springframework.org/schema/integration/jdbc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:int-jmx="http://www.springframework.org/schema/integration/jmx" xmlns:int-amqp="http://www.springframework.org/schema/integration/amqp"
  xmlns:rabbit="http://www.springframework.org/schema/rabbit" xmlns:lang="http://www.springframework.org/schema/lang"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/jms
  http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
  http://www.springframework.org/schema/integration/amqp
  http://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd
  http://www.springframework.org/schema/rabbit
  http://www.springframework.org/schema/rabbit/spring-rabbit.xsd
  http://www.springframework.org/schema/integration/file
  http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
  http://www.springframework.org/schema/integration/jdbc
  http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc.xsd
  http://www.springframework.org/schema/integration/jmx
  http://www.springframework.org/schema/integration/jmx/spring-integration-jmx.xsd
  http://www.springframework.org/schema/lang
  http://www.springframework.org/schema/lang/spring-lang.xsd">
  <!-- Configuration file for harvesting from a RabbitMQ message queue -->
  <int-jmx:mbean-export
    default-domain="au.com.redboxresearchdata.harvester.client.sample.jdbc" server="mbeanServer"/>

  <rabbit:connection-factory host="${harvest.rabbitmq.url}" port="${harvest.rabbitmq.port}" id="rabbitConnectionFactory"
    password="${harvest.rabbitmq.password}" username="${harvest.rabbitmq.username}"/>
  <rabbit:template connection-factory="rabbitConnectionFactory" id="amqpTemplate"/>
  <rabbit:admin connection-factory="rabbitConnectionFactory"/>
  <rabbit:queue id='${harvest.rabbitmq.queuename}' name='${harvest.rabbitmq.queuename}'/>

  <int-amqp:inbound-channel-adapter channel="datasetIn"
    connection-factory="rabbitConnectionFactory" queue-names="${harvest.rabbitmq.queuename}"/>

  <poller default="true" fixed-delay="${harvest.pollRate}"
    receive-timeout="${harvest.pollTimeout}" xmlns="http://www.springframework.org/schema/integration">
    <transactional isolation="SERIALIZABLE"/>
  </poller>

  <int:header-enricher input-channel="datasetIn"
    output-channel="redboxRecordMapperChannel">
    <int:header name="type" value="Dataset"/>
  </int:header-enricher>

  <int:transformer id="arms2RedboxJson" input-channel="redboxRecordMapperChannel"
    method="handleJson" output-channel="jdbcHarvestChannel" ref="arms2redboxmapper"/>

  <lang:groovy id="arms2redboxmapper"
    script-source="file:${client.base}resources/scripts/arms2redboxmapper.groovy">
    <lang:property name="config" value="#{placeholderProperties.config}"/>
  </lang:groovy>
		
	<int-jms:outbound-channel-adapter id="jmsOut" destination="requestQueue" channel="jdbcHarvestChannel"/> 
	
	<int:channel id="jdbcHarvestChannel">
		<int:interceptors>
			<int:wire-tap channel="jdbcloggingChannel" />
		</int:interceptors>
	</int:channel> 

	<int:logging-channel-adapter id="jdbcloggingChannel"
		expression="'Processing JDBC record of type:' + headers.type" />

	<bean id="transformationHandler"
		class="au.com.redboxresearchdata.harvester.json.transformer.JsonTransformationHandler" >
		<property name="config" value="#{placeholderProperties.config}" />
	</bean>
		
		
	
	<bean id="placeholderProperties" class="au.com.redboxresearchdata.util.config.ConfigSlurperPlaceholderConfigurer">
		<property name="environment" value="#{grailsApplication.getConfig().get('environment')}"/>
		<property name="defaultEnvironment" value="production" />
		<property name="config" value="#{grailsApplication.getConfig().get('clientConfigObj')}" />
	</bean>			
	
	<bean id="connectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
        <property name="brokerURL" value="${activemq.url}" />
    </bean>
    <bean id="requestQueue" class="org.apache.activemq.command.ActiveMQQueue">
		<constructor-arg value="jsonHarvester"/>
	</bean>
	<bean id="datasetConfigSqlParamSource" class="au.com.redboxresearchdata.jdbc.ConfigSqlParameterSource" >
		<property name="config" value="#{placeholderProperties.config}" />
		<property name="type" value="Dataset" />
	</bean> 	
</beans>
